---

title: relational


keywords: fastai
sidebar: home_sidebar

summary: "This module implements a single function containing the relational block from [A simple neural network module for relational reasoning][relational]."
description: "This module implements a single function containing the relational block from [A simple neural network module for relational reasoning][relational]."
nb_path: "00_core.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 00_core.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>I'm going to show that this works with Numpy and PyTorch without doing anything else:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Agnostic-cat">Agnostic <a href="/relational/core.html#cat"><code>cat</code></a><a class="anchor-link" href="#Agnostic-cat"> </a></h2><p>I need an agnostic cat function that's going to produce concatenated arrays or tensors regardless of what's passed. Also, using this hack so it doesn't care if Numpy or PyTorch aren't installed.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="cat" class="doc_header"><code>cat</code><a href="https://github.com/gngdb/relational/tree/master/relational/core.py#L16" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>cat</code>(<strong><code>xs</code></strong>, <strong><code>axis</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Showing that this works with either arrays or tensors:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">xs</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)]</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">cat</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">c</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>array([[ 1.76405235,  0.40015721,  1.86755799, -0.97727788, -0.10321885,
         0.4105985 ,  0.76103773,  0.12167502],
       [ 0.97873798,  2.2408932 ,  0.95008842, -0.15135721,  0.14404357,
         1.45427351,  0.44386323,  0.33367433]])</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">xs</span> <span class="o">=</span> <span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xs</span><span class="p">]</span>
<span class="n">_c</span> <span class="o">=</span> <span class="n">cat</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">c</span> <span class="o">-</span> <span class="n">_c</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">1e-3</span>
<span class="n">_c</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor([[ 1.7641,  0.4002,  1.8676, -0.9773, -0.1032,  0.4106,  0.7610,  0.1217],
        [ 0.9787,  2.2409,  0.9501, -0.1514,  0.1440,  1.4543,  0.4439,  0.3337]],
       dtype=torch.float64)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Pairing">Pairing<a class="anchor-link" href="#Pairing"> </a></h2><p>This is closely based on <a href="https://github.com/Kaixhin/pytorch/blob/3e49e198c2351c24f32365713db9639d232b8e3e/torch/nn/functional.py">Kai Arulkumaran's relation function</a> so I'm going to test the results of einops operations against that code. The first function I need concatenates the cartesian product of pairs on the trailing dimension. Example of what a cartesian product is:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">urllib</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span><span class="p">,</span><span class="n">SVG</span>
<span class="n">u</span> <span class="o">=</span> <span class="s2">&quot;https://upload.wikimedia.org/wikipedia/commons/4/4e/Cartesian_Product_qtl1.svg&quot;</span>
<span class="k">with</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">svg_string</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">display</span><span class="p">(</span><span class="n">SVG</span><span class="p">(</span><span class="n">svg_string</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_svg output_subarea ">
<svg xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape" width="501.04968" height="381" id="svg2" version="1.1" inkscape:version="0.48.0 r9654" sodipodi:docname="kart-prod-1.svg">
  <defs id="defs4"/>
  <sodipodi:namedview id="base" pagecolor="#ffffff" bordercolor="#666666" borderopacity="1.0" inkscape:pageopacity="0.0" inkscape:pageshadow="2" inkscape:zoom="1.4" inkscape:cx="246.42474" inkscape:cy="196.08422" inkscape:document-units="px" inkscape:current-layer="layer1" showgrid="true" inkscape:snap-grids="true" inkscape:snap-to-guides="true" inkscape:snap-global="false" inkscape:window-width="1621" inkscape:window-height="878" inkscape:window-x="25" inkscape:window-y="25" inkscape:window-maximized="0" fit-margin-top="10" fit-margin-left="10" fit-margin-right="10" fit-margin-bottom="10" showborder="true" showguides="true" inkscape:guide-bbox="true">
    <inkscape:grid type="xygrid" id="grid2985" empspacing="5" visible="true" enabled="true" snapvisiblegridlinesonly="true" spacingx="10px" spacingy="10px"/>
  </sodipodi:namedview>
  <metadata id="metadata7">
    <rdf:RDF>
      <cc:Work rdf:about="">
        <dc:format>image/svg+xml</dc:format>
        <dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage"/>
        <dc:title/>
      </cc:Work>
    </rdf:RDF>
  </metadata>
  <g inkscape:label="Ebene 1" inkscape:groupmode="layer" id="layer1" transform="translate(-100.21094,-341.86218)">
    <rect style="opacity:0.15;fill:#008080;fill-opacity:1;stroke:none" id="rect4118" width="300" height="300" x="200" y="412.36218" rx="70" ry="70"/>
    <path style="fill:none;stroke:#000000;stroke-width:1;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-opacity:1;stroke-dasharray:2, 2;stroke-dashoffset:0" d="m 300,412.36218 0,300" id="path2991" inkscape:connector-curvature="0" sodipodi:nodetypes="cc"/>
    <path style="fill:none;stroke:#000000;stroke-width:1;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-opacity:1;stroke-dasharray:2, 2;stroke-dashoffset:0" d="m 400,412.36218 0,300" id="path2993" inkscape:connector-curvature="0" sodipodi:nodetypes="cc"/>
    <path sodipodi:type="arc" style="opacity:0.14999999999999999;fill:#d40000;fill-opacity:1;stroke:none" id="path3307" sodipodi:cx="175" sodipodi:cy="502.36218" sodipodi:rx="25" sodipodi:ry="150" d="m 200,502.36218 a 25,150 0 1 1 -50,0 25,150 0 1 1 50,0 z" transform="translate(-10,60)"/>
    <path style="fill:none;stroke:#000000;stroke-width:1;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-opacity:1;stroke-dasharray:2, 2;stroke-dashoffset:0" d="m 200,512.36218 300,0" id="path2999" inkscape:connector-curvature="0" sodipodi:nodetypes="cc"/>
    <path style="fill:none;stroke:#000000;stroke-width:1;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-opacity:1;stroke-dasharray:2, 2;stroke-dashoffset:0" d="m 200,612.36218 300,0" id="path3001" inkscape:connector-curvature="0" sodipodi:nodetypes="cc"/>
    <text xml:space="preserve" style="font-size:56px;font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;text-align:end;line-height:125%;letter-spacing:0px;word-spacing:0px;writing-mode:lr-tb;text-anchor:end;fill:#000000;fill-opacity:1;stroke:none;font-family:Arial;-inkscape-font-specification:Arial" x="282.28564" y="671.07648" id="text3034" sodipodi:linespacing="125%"><tspan sodipodi:role="line" id="tspan3036" x="282.28564" y="671.07648" style="font-size:32px">(<tspan style="font-style:oblique;fill:#d40000;-inkscape-font-specification:Arial Oblique" id="tspan3075">z</tspan>,<tspan style="fill:#008000" id="tspan3089">1</tspan>)</tspan></text>
    <text xml:space="preserve" style="font-size:56px;font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;text-align:end;line-height:125%;letter-spacing:0px;word-spacing:0px;writing-mode:lr-tb;text-anchor:end;fill:#000000;fill-opacity:1;stroke:none;font-family:Arial;-inkscape-font-specification:Arial" x="382.42853" y="671.07648" id="text3034-0" sodipodi:linespacing="125%"><tspan sodipodi:role="line" id="tspan3036-2" x="382.42853" y="671.07648" style="font-size:32px">(<tspan style="font-style:oblique;fill:#d40000;-inkscape-font-specification:Arial Oblique" id="tspan3081">z</tspan>,<tspan style="fill:#008000" id="tspan3093">2</tspan>)</tspan></text>
    <text xml:space="preserve" style="font-size:56px;font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;text-align:end;line-height:125%;letter-spacing:0px;word-spacing:0px;writing-mode:lr-tb;text-anchor:end;fill:#000000;fill-opacity:1;stroke:none;font-family:Arial;-inkscape-font-specification:Arial" x="482.42853" y="671.07648" id="text3034-8" sodipodi:linespacing="125%"><tspan sodipodi:role="line" id="tspan3036-9" x="482.42853" y="671.07648" style="font-size:32px">(<tspan style="font-style:oblique;fill:#d40000;-inkscape-font-specification:Arial Oblique" id="tspan3329">z</tspan>,<tspan style="fill:#008000" id="tspan3066">3</tspan>)</tspan></text>
    <text xml:space="preserve" style="font-size:56px;font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;text-align:end;line-height:125%;letter-spacing:0px;word-spacing:0px;writing-mode:lr-tb;text-anchor:end;fill:#000000;fill-opacity:1;stroke:none;font-family:Arial;-inkscape-font-specification:Arial" x="282.28564" y="571.07648" id="text3034-1" sodipodi:linespacing="125%"><tspan sodipodi:role="line" id="tspan3036-8" x="282.28564" y="571.07648" style="font-size:32px">(<tspan style="font-style:oblique;fill:#d40000;-inkscape-font-specification:Arial Oblique" id="tspan3067">y</tspan>,<tspan style="fill:#008000" id="tspan3087">1</tspan>)</tspan></text>
    <text xml:space="preserve" style="font-size:56px;font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;text-align:end;line-height:125%;letter-spacing:0px;word-spacing:0px;writing-mode:lr-tb;text-anchor:end;fill:#000000;fill-opacity:1;stroke:none;font-family:Arial;-inkscape-font-specification:Arial" x="382.42853" y="571.07648" id="text3034-0-6" sodipodi:linespacing="125%"><tspan sodipodi:role="line" id="tspan3036-2-0" x="382.42853" y="571.07648" style="font-size:32px">(<tspan style="font-style:oblique;fill:#d40000;-inkscape-font-specification:Arial Oblique" id="tspan3325">y</tspan>,<tspan style="fill:#008000" id="tspan3254">2</tspan>)</tspan></text>
    <text xml:space="preserve" style="font-size:56px;font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;text-align:end;line-height:125%;letter-spacing:0px;word-spacing:0px;writing-mode:lr-tb;text-anchor:end;fill:#000000;fill-opacity:1;stroke:none;font-family:Arial;-inkscape-font-specification:Arial" x="482.42853" y="571.07648" id="text3034-8-4" sodipodi:linespacing="125%"><tspan sodipodi:role="line" id="tspan3036-9-7" x="482.42853" y="571.07648" style="font-size:32px">(<tspan style="font-style:oblique;fill:#d40000;-inkscape-font-specification:Arial Oblique" id="tspan3071">y</tspan>,<tspan style="fill:#008000" id="tspan3097">3</tspan>)</tspan></text>
    <text xml:space="preserve" style="font-size:56px;font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;text-align:end;line-height:125%;letter-spacing:0px;word-spacing:0px;writing-mode:lr-tb;text-anchor:end;fill:#000000;fill-opacity:1;stroke:none;font-family:Arial;-inkscape-font-specification:Arial" x="282.28564" y="471.07648" id="text3034-3" sodipodi:linespacing="125%"><tspan sodipodi:role="line" id="tspan3036-6" x="282.28564" y="471.07648" style="font-size:32px">(<tspan style="font-style:oblique;fill:#d40000;-inkscape-font-specification:Arial Oblique" id="tspan3311">x</tspan>,<tspan style="fill:#008000" id="tspan3058">1</tspan>)</tspan></text>
    <text xml:space="preserve" style="font-size:56px;font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;text-align:end;line-height:125%;letter-spacing:0px;word-spacing:0px;writing-mode:lr-tb;text-anchor:end;fill:#000000;fill-opacity:1;stroke:none;font-family:Arial;-inkscape-font-specification:Arial" x="382.42853" y="471.07648" id="text3034-0-2" sodipodi:linespacing="125%"><tspan sodipodi:role="line" id="tspan3036-2-4" x="382.42853" y="471.07648" style="font-size:32px">(<tspan style="font-style:oblique;fill:#d40000;-inkscape-font-specification:Arial Oblique" id="tspan3057">x</tspan>,<tspan style="fill:#008000" id="tspan3091">2</tspan>)</tspan></text>
    <text xml:space="preserve" style="font-size:56px;font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;text-align:end;line-height:125%;letter-spacing:0px;word-spacing:0px;writing-mode:lr-tb;text-anchor:end;fill:#000000;fill-opacity:1;stroke:none;font-family:Arial;-inkscape-font-specification:Arial" x="482.42853" y="471.07648" id="text3034-8-9" sodipodi:linespacing="125%"><tspan sodipodi:role="line" id="tspan3036-9-73" x="482.42853" y="471.07648" style="font-size:32px">(<tspan style="font-style:oblique;fill:#d40000;-inkscape-font-specification:Arial Oblique" id="tspan3061">x</tspan>,<tspan style="fill:#008000" id="tspan3095">3</tspan>)</tspan></text>
    <text xml:space="preserve" style="font-size:56px;font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;text-align:end;line-height:125%;letter-spacing:0px;word-spacing:0px;writing-mode:lr-tb;text-anchor:end;fill:#000000;fill-opacity:1;stroke:none;font-family:cmmi12;-inkscape-font-specification:cmmi12" x="237.85715" y="673.79077" id="text3118" sodipodi:linespacing="125%"><tspan sodipodi:role="line" id="tspan3120" x="237.85715" y="673.79077"/></text>
    <path sodipodi:type="arc" style="opacity:0.14999999999999999;fill:#008000;fill-opacity:1;stroke:none" id="path3309" sodipodi:cx="350" sodipodi:cy="677.36218" sodipodi:rx="150" sodipodi:ry="25" d="m 500,677.36218 a 150,25 0 1 1 -300,0 150,25 0 1 1 300,0 z" transform="translate(0,-300)"/>
    <text xml:space="preserve" style="font-size:56px;font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;text-align:end;line-height:125%;letter-spacing:0px;word-spacing:0px;writing-mode:lr-tb;text-anchor:end;fill:#000000;fill-opacity:1;stroke:none;font-family:Arial;-inkscape-font-specification:Arial" x="261.85712" y="387.07648" id="text3034-5" sodipodi:linespacing="125%"><tspan sodipodi:role="line" id="tspan3036-82" x="261.85712" y="387.07648" style="font-size:32px;font-style:normal;fill:#008000;-inkscape-font-specification:Arial">1</tspan></text>
    <text xml:space="preserve" style="font-size:56px;font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;text-align:end;line-height:125%;letter-spacing:0px;word-spacing:0px;writing-mode:lr-tb;text-anchor:end;fill:#000000;fill-opacity:1;stroke:none;font-family:Arial;-inkscape-font-specification:Arial" x="362" y="387.07648" id="text3034-5-9" sodipodi:linespacing="125%"><tspan sodipodi:role="line" id="tspan3036-82-3" x="362" y="387.07648" style="font-size:32px;font-style:normal;fill:#008000;-inkscape-font-specification:Arial">2</tspan></text>
    <text xml:space="preserve" style="font-size:56px;font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;text-align:end;line-height:125%;letter-spacing:0px;word-spacing:0px;writing-mode:lr-tb;text-anchor:end;fill:#000000;fill-opacity:1;stroke:none;font-family:Arial;-inkscape-font-specification:Arial" x="462" y="387.07648" id="text3034-5-2" sodipodi:linespacing="125%"><tspan sodipodi:role="line" id="tspan3036-82-6" x="462" y="387.07648" style="font-size:32px;font-style:normal;fill:#008000;-inkscape-font-specification:Arial">3</tspan></text>
    <text xml:space="preserve" style="font-size:56px;font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;text-align:end;line-height:125%;letter-spacing:0px;word-spacing:0px;writing-mode:lr-tb;text-anchor:end;fill:#000000;fill-opacity:1;stroke:none;font-family:Arial;-inkscape-font-specification:Arial" x="173.42856" y="671.05621" id="text3034-5-5" sodipodi:linespacing="125%"><tspan sodipodi:role="line" id="tspan3036-82-5" x="173.42856" y="671.05621" style="font-size:32px;font-style:oblique;fill:#d40000;-inkscape-font-specification:Arial Oblique">z</tspan></text>
    <text xml:space="preserve" style="font-size:56px;font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;text-align:end;line-height:125%;letter-spacing:0px;word-spacing:0px;writing-mode:lr-tb;text-anchor:end;fill:#000000;fill-opacity:1;stroke:none;font-family:Arial;-inkscape-font-specification:Arial" x="173.42856" y="571.05621" id="text3034-5-5-2" sodipodi:linespacing="125%"><tspan sodipodi:role="line" id="tspan3036-82-5-0" x="173.42856" y="571.05621" style="font-size:32px;font-style:oblique;fill:#d40000;-inkscape-font-specification:Arial Oblique">y</tspan></text>
    <text xml:space="preserve" style="font-size:56px;font-style:oblique;font-variant:normal;font-weight:normal;font-stretch:normal;text-align:end;line-height:125%;letter-spacing:0px;word-spacing:0px;writing-mode:lr-tb;text-anchor:end;fill:#000000;fill-opacity:1;stroke:none;font-family:Arial;-inkscape-font-specification:Arial Oblique" x="173.42856" y="471.05621" id="text3034-5-5-5" sodipodi:linespacing="125%"><tspan sodipodi:role="line" id="tspan3036-82-5-2" x="173.42856" y="471.05621" style="font-size:32px;fill:#d40000;font-style:oblique;-inkscape-font-specification:Arial Oblique">x</tspan></text>
    <rect style="fill:none;stroke:#008080" id="rect4118-2" width="300" height="300" x="200" y="412.36218" rx="70" ry="70"/>
    <path sodipodi:type="arc" style="fill:none;stroke:#d40000" id="path3307-2" sodipodi:cx="175" sodipodi:cy="502.36218" sodipodi:rx="25" sodipodi:ry="150" d="m 200,502.36218 a 25,150 0 1 1 -50,0 25,150 0 1 1 50,0 z" transform="translate(-10,60)"/>
    <path sodipodi:type="arc" style="fill:none;stroke:#008000" id="path3309-9" sodipodi:cx="350" sodipodi:cy="677.36218" sodipodi:rx="150" sodipodi:ry="25" d="m 500,677.36218 a 150,25 0 1 1 -300,0 150,25 0 1 1 300,0 z" transform="translate(0,-300)"/>
    <text xml:space="preserve" style="font-size:56px;font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;text-align:end;line-height:125%;letter-spacing:0px;word-spacing:0px;writing-mode:lr-tb;text-anchor:end;fill:#000000;fill-opacity:1;stroke:none;font-family:cmmi12;-inkscape-font-specification:cmmi12" x="566.42859" y="708.07648" id="text4174" sodipodi:linespacing="125%"><tspan sodipodi:role="line" id="tspan4176" x="566.42859" y="708.07648"/></text>
    <text xml:space="preserve" style="font-size:56px;font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;text-align:end;line-height:125%;letter-spacing:0px;word-spacing:0px;writing-mode:lr-tb;text-anchor:end;fill:#000000;fill-opacity:1;stroke:none;font-family:Arial;-inkscape-font-specification:Arial" x="537.85718" y="402.36218" id="text3034-5-5-6" sodipodi:linespacing="125%"><tspan sodipodi:role="line" id="tspan3036-82-5-4" x="537.85718" y="402.36218" style="font-size:40px;font-style:oblique;fill:#000000;-inkscape-font-specification:Arial Oblique">B</tspan></text>
    <text xml:space="preserve" style="font-size:56px;font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;text-align:end;line-height:125%;letter-spacing:0px;word-spacing:0px;writing-mode:lr-tb;text-anchor:end;fill:#000000;fill-opacity:1;stroke:none;font-family:Arial;-inkscape-font-specification:Arial" x="134" y="444.36218" id="text3034-5-5-6-0" sodipodi:linespacing="125%"><tspan sodipodi:role="line" id="tspan3036-82-5-4-4" x="134" y="444.36218" style="font-size:40px;font-style:oblique;fill:#000000;-inkscape-font-specification:Arial Oblique">A</tspan></text>
    <text xml:space="preserve" style="font-size:40px;font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;text-align:end;line-height:125%;letter-spacing:0px;word-spacing:0px;writing-mode:lr-tb;text-anchor:end;fill:#000000;fill-opacity:1;stroke:none;font-family:Arial;-inkscape-font-specification:Arial" x="593.42859" y="546.36218" id="text3034-5-5-6-4" sodipodi:linespacing="125%"><tspan sodipodi:role="line" id="tspan4229" x="593.42859" y="546.36218" dy="0 0.71428573"><tspan style="font-style:oblique;-inkscape-font-specification:Arial Oblique" id="tspan4283">A</tspan>Ã—<tspan style="font-style:oblique;-inkscape-font-specification:Arial Oblique" id="tspan4285">B</tspan></tspan></text>
    <path style="fill:#000000;stroke:#000000;stroke-width:1px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1" d="M 150.89286,438.43361 134.6967,433.11979" id="path4277" inkscape:connector-curvature="0" sodipodi:nodetypes="cc"/>
    <path style="fill:none;stroke:#000000;stroke-width:1px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1" d="M 511.03572,388.46932 496.75,382.93361" id="path4279" inkscape:connector-curvature="0" sodipodi:nodetypes="cc"/>
    <path style="fill:none;stroke:#000000;stroke-width:1px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1" d="m 516.25,532.94253 -15.86113,3.35456" id="path4281" inkscape:connector-curvature="0" sodipodi:nodetypes="cc"/>
  </g>
</svg>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>It might be possible to do this with <a href="https://pytorch.org/docs/stable/generated/torch.cartesian_prod.html">torch.cartesian_prod</a> and <a href="https://pytorch.org/docs/stable/generated/torch.gather.html">gather</a> but it also needs to be batched. Instead, I do it here using repeat.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">16</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Copying Kai's code and using einops:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">kai_prodpair</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">b</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">x</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">o</span> <span class="o">*</span> <span class="n">o</span><span class="p">,</span> <span class="n">c</span><span class="p">),</span>
                      <span class="n">x</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">o</span> <span class="o">*</span> <span class="n">o</span><span class="p">,</span> <span class="n">c</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">prodpair</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">b</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">return</span> <span class="n">cat</span><span class="p">([</span><span class="n">repeat</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;b o c -&gt; b (m o) c&#39;</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="n">o</span><span class="p">),</span>
                <span class="n">repeat</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;b o c -&gt; b (o m) c&#39;</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="n">o</span><span class="p">)],</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>I'm going to need to check if a lot of tensors are equal so we'll need this utility function:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">allclose</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">epsilon</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">assert</span> <span class="n">allclose</span><span class="p">(</span><span class="n">kai_prodpair</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">prodpair</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>I wanted to check if this was precisely a cartesian product, but it's not because of the order of the arguments into <a href="/relational/core.html#cat"><code>cat</code></a>.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">cartesian_trailing</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">b</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">o</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">o</span><span class="p">):</span>
                <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rearrange</span><span class="p">(</span><span class="n">cat</span><span class="p">([</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">],</span> <span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;c2 -&gt; () c2&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">rearrange</span><span class="p">(</span><span class="n">cat</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;(b osq) c2 -&gt; b osq c2&#39;</span><span class="p">,</span> <span class="n">osq</span><span class="o">=</span><span class="n">o</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">c2</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">c</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">eq</span> <span class="o">=</span> <span class="n">allclose</span><span class="p">(</span><span class="n">prodpair</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">cartesian_trailing</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Is prodpair a cartesian product? </span><span class="si">{</span><span class="s1">&#39;yes&#39;</span> <span class="k">if</span> <span class="n">eq</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;no&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Is prodpair a cartesian product? no
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>So, I'll reverse that for the implementation, just so I can say it's really a cartesian product.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="prodpair" class="doc_header"><code>prodpair</code><a href="https://github.com/gngdb/relational/tree/master/relational/core.py#L23" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>prodpair</code>(<strong><code>x</code></strong>)</p>
</blockquote>
<p>Creates cartesian pairwise matrix for each example in the minibatch,
pairing vectors on the trailing dimension.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">err</span> <span class="o">=</span> <span class="n">allclose</span><span class="p">(</span><span class="n">prodpair</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">cartesian_trailing</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<span class="k">assert</span> <span class="n">err</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Is prodpair a cartesian product now? </span><span class="si">{</span><span class="s1">&#39;yes&#39;</span> <span class="k">if</span> <span class="n">err</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;no&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Is prodpair a cartesian product now? yes
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Append-embedding">Append embedding<a class="anchor-link" href="#Append-embedding"> </a></h2><p>Relation networks need the option to add an embedding vector to each element.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">kai_append_embedding</span><span class="p">(</span><span class="n">pairs</span><span class="p">,</span> <span class="n">embedding</span><span class="p">):</span>
    <span class="n">b</span><span class="p">,</span> <span class="n">osq</span><span class="p">,</span> <span class="n">c2</span> <span class="o">=</span> <span class="n">pairs</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">pairs</span><span class="p">,</span> <span class="n">embedding</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">osq</span><span class="p">,</span> <span class="n">embedding</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">))),</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="append_embedding" class="doc_header"><code>append_embedding</code><a href="https://github.com/gngdb/relational/tree/master/relational/core.py#L31" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>append_embedding</code>(<strong><code>pairs</code></strong>, <strong><code>embedding</code></strong>)</p>
</blockquote>
<p>Add an embedding to every paired token.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Checking the einops version is correct:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">b</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
<span class="n">pairs</span> <span class="o">=</span> <span class="n">prodpair</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">embedding</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">allclose</span><span class="p">(</span><span class="n">append_embedding</span><span class="p">(</span><span class="n">pairs</span><span class="p">,</span> <span class="n">embedding</span><span class="p">),</span> <span class="n">kai_append_embedding</span><span class="p">(</span><span class="n">pairs</span><span class="p">,</span> <span class="n">embedding</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Applying-g">Applying <code>g</code><a class="anchor-link" href="#Applying-g"> </a></h2><p><code>g</code> is a function applied to all pairs and their embeddings. It's assumed to take a two dimensional tensor as input so the tensor is rearranged before and after applying it. All that's left to compute the relational function is to take the sum of the resulting representations over all pairs. I've added the option to reduce using <code>mean</code> instead if required using the kwarg <code>reduction</code>.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="relation" class="doc_header"><code>relation</code><a href="https://github.com/gngdb/relational/tree/master/relational/core.py#L37" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>relation</code>(<strong><code>input</code></strong>, <strong><code>g</code></strong>, <strong><code>embedding</code></strong>=<em><code>None</code></em>, <strong><code>max_pairwise</code></strong>=<em><code>None</code></em>, <strong><code>reduction</code></strong>=<em><code>'sum'</code></em>)</p>
</blockquote>
<p>Applies an all-to-all pairwise relation function to a set of objects.
See :class:<code>~torch.nn.Relation</code> for details.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Integration-test">Integration test<a class="anchor-link" href="#Integration-test"> </a></h2><p>Testing that the result of this function is equal to Kai's implementation. The only difference is the order of the pairs, and that doesn't affect the result.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">kai_relation</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">embedding</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_pairwise</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Applies an all-to-all pairwise relation function to a set of objects.</span>
<span class="sd">    See :class:`~torch.nn.Relation` for details.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Batch size, number of objects, feature size</span>
    <span class="n">b</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
    <span class="c1"># Create pairwise matrix</span>
    <span class="n">pairs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="nb">input</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">o</span> <span class="o">*</span> <span class="n">o</span><span class="p">,</span> <span class="n">c</span><span class="p">),</span>
                       <span class="nb">input</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">o</span> <span class="o">*</span> <span class="n">o</span><span class="p">,</span> <span class="n">c</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span>
    <span class="c1"># Append embedding if provided</span>
    <span class="k">if</span> <span class="n">embedding</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pairs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">pairs</span><span class="p">,</span> <span class="n">embedding</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">o</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">embedding</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">))),</span> <span class="mi">2</span><span class="p">)</span>
    <span class="c1"># Calculate new feature size</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">pairs</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="c1"># Pack into batches</span>
    <span class="n">pairs</span> <span class="o">=</span> <span class="n">pairs</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">b</span> <span class="o">*</span> <span class="n">o</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
    <span class="c1"># Pass through g</span>
    <span class="k">if</span> <span class="n">max_pairwise</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">g</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">b</span> <span class="o">*</span> <span class="n">o</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">max_pairwise</span><span class="p">):</span>
            <span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g</span><span class="p">(</span><span class="n">pairs</span><span class="p">[</span><span class="n">batch</span><span class="p">:</span><span class="n">batch</span> <span class="o">+</span> <span class="n">max_pairwise</span><span class="p">]))</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="c1"># Unpack</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">o</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">output</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">dummy_g</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="k">return</span> <span class="n">x</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">assert</span> <span class="n">allclose</span><span class="p">(</span><span class="n">kai_relation</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dummy_g</span><span class="p">),</span> <span class="n">relation</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dummy_g</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Is-this-agnostic-to-numpy?">Is this agnostic to numpy?<a class="anchor-link" href="#Is-this-agnostic-to-numpy?"> </a></h2><p>The function works the same if I cast the input to be a numpy array.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">assert</span> <span class="n">allclose</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">relation</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">dummy_g</span><span class="p">)),</span> <span class="n">relation</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dummy_g</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

